parameters:
  - name: env
    type: string
    default: SpecifyEnv
steps:
  - download: current
    artifact: drop
    patterns: '**/*_${{ parameters.env }}.yaml'
  - task: KubernetesManifest@0
    displayName: Scale NiFiRegistry down
    continueOnError: 'true'
    inputs: 
      action: scale
      kind: deployment
      name: odlnifiregistry
      replicas: 0
      namespace: $(Environment.ResourceName)    
  - task: KubernetesManifest@0
    displayName: Stop NiFi Pods
    inputs:
      action: delete
      arguments: pod -l app=odlnifi
      namespace: $(Environment.ResourceName)
  - task: KubernetesManifest@0
    displayName: Scale NiFi down
    continueOnError: 'true'
    inputs: 
      action: scale
      kind: statefulset
      name: odlnifi
      replicas: 0
      namespace: $(Environment.ResourceName) 
  - task: KubernetesManifest@0
    displayName: Scale Zookeeper down
    continueOnError: 'true'
    inputs: 
      action: scale
      kind: statefulset
      name: zk
      replicas: 0
      namespace: $(Environment.ResourceName)
  - task: KubernetesManifest@0
    displayName: Deploy NiFi Registry
    inputs:
      action: deploy
      namespace: $(Environment.ResourceName)
      manifests: $(Pipeline.Workspace)/drop/nifiregistry_*.yaml
  - task: KubernetesManifest@0
    displayName: Deploy zk
    inputs:
      action: deploy
      namespace: $(Environment.ResourceName)
      manifests: $(Pipeline.Workspace)/drop/zk_*.yaml
  - task: KubernetesManifest@0
    displayName: Deploy NiFi
    inputs:
      action: deploy
      namespace: $(Environment.ResourceName)
      manifests: $(Pipeline.Workspace)/drop/nifi_*.yaml